@startuml CostPlansDatabase_Schema
!theme plain
skinparam linetype ortho
skinparam classAttributeIconSize 0
skinparam roundcorner 8
skinparam defaultFontSize 10
skinparam classFontSize 12

hide circle
hide methods

' ═══════════════════════════════════════════════════════════
'  STEREOTYPE STYLES
' ═══════════════════════════════════════════════════════════

skinparam class {
  BackgroundColor<<ref>> #E3F2FD
  BorderColor<<ref>> #1565C0
  BackgroundColor<<fact>> #FFF3E0
  BorderColor<<fact>> #E65100
  BackgroundColor<<map>> #E8F5E9
  BorderColor<<map>> #2E7D32
  BackgroundColor<<auto-generated>> #F3E5F5
  BorderColor<<auto-generated>> #7B1FA2
}

' ═══════════════════════════════════════════════════════════
'  REFERENCE TABLES (light blue)
' ═══════════════════════════════════════════════════════════

package "Reference Tables" <<Rectangle>> {

  class ref_countries <<ref>> {
    **country_id** : INT <<PK>>
    --
    country_name : NVARCHAR(120) <<UQ>>
    country_code : CHAR(3) <<UQ>>
    is_active : BIT
  }

  class ref_divisions <<ref>> {
    **division_id** : INT <<PK>>
    --
    division_code : NVARCHAR(50) <<UQ>>
    division_name : NVARCHAR(200) <<UQ>>
    division_description : NVARCHAR(500)
    is_active : BIT
  }

  class ref_branches <<ref>> {
    **branch_id** : INT <<PK>>
    --
    division_id : INT <<FK>>
    branch_name : NVARCHAR(200)
    branch_code : NVARCHAR(20)
    branch_description : NVARCHAR(500)
    is_active : BIT
    ..
    <<UQ>> (division_id, branch_name)
  }

  class ref_sections <<ref>> {
    **section_id** : INT <<PK>>
    --
    branch_id : INT <<FK>>
    section_name : NVARCHAR(200)
    country_id : INT <<FK>>
    is_active : BIT
    ..
    <<UQ>> (branch_id, section_name)
  }

  class ref_duty_stations <<ref>> {
    **duty_station_id** : INT <<PK>>
    --
    duty_station_name : NVARCHAR(120)
    country_id : INT <<FK>>
    currency : VARCHAR(100)
    symbol : NVARCHAR(5)
    is_active : BIT
    ..
    <<UQ>> (name, country)
  }

  class ref_post_categories <<ref>> {
    **post_category_id** : INT <<PK>>
    --
    post_category_code : NVARCHAR(20) <<UQ>>
    post_category_name : NVARCHAR(120) <<UQ>>
    description : NVARCHAR(255)
    is_active : BIT
  }

  class ref_post_grades <<ref>> {
    **post_grade_id** : INT <<PK>>
    --
    post_category_id : INT <<FK>>
    grade_code : NVARCHAR(20)
    grade_level : INT
    is_active : BIT
    ..
    <<UQ>> (post_category_id, grade_code)
  }

  class ref_umoja_classes <<ref>> {
    **umoja_class_id** : INT <<PK>>
    --
    umoja_class_code : NVARCHAR(50) <<UQ>>
    umoja_class_name : NVARCHAR(200) <<UQ>>
    description : NVARCHAR(500)
    is_active : BIT
  }

  class ref_operating_cost_categories <<ref>> {
    **operating_cost_category_id** : INT <<PK>>
    --
    umoja_class_id : INT <<FK>>
    category_code : NVARCHAR(50)
    category_name : NVARCHAR(200)
    description : NVARCHAR(500)
    commitment_item_code : NVARCHAR(20)
    sort_order : INT
    is_active : BIT
    ..
    <<UQ>> (category_code, category_name)
  }

  class ref_activity_categories <<ref>> {
    **activity_category_id** : INT <<PK>>
    --
    umoja_class_id : INT <<FK>>
    activity_code : NVARCHAR(50) <<UQ>>
    activity_name : NVARCHAR(200) <<UQ>>
    description : NVARCHAR(500)
    is_active : BIT
  }

  class ref_projects <<ref>> {
    **project_id** : INT <<PK>>
    --
    project_wbse : NVARCHAR(50) <<UQ>>
    project_name : NVARCHAR(500)
    section_id : INT <<FK>>
    implementing_grant : NVARCHAR(100)
    trust_fund : NVARCHAR(50)
    project_end_date : DATE
    earmarking_type : NVARCHAR(50)
    is_active : BIT
  }

  class ref_user_roles <<ref>> {
    **user_role_id** : INT <<PK>>
    --
    role_code : NVARCHAR(50) <<UQ>>
    role_name : NVARCHAR(150)
    role_description : NVARCHAR(500)
    is_active : BIT
  }
}

' ═══════════════════════════════════════════════════════════
'  CORE ENTITIES (orange)
' ═══════════════════════════════════════════════════════════

package "Core Entities" <<Rectangle>> {

  class fact_users <<fact>> {
    **user_id** : INT <<PK>>
    --
    username : NVARCHAR(100) <<UQ>>
    full_name : NVARCHAR(200)
    email : NVARCHAR(200) <<UQ>>
    is_active : BIT
  }

  class fact_cost_plan_years <<fact>> {
    **cost_plan_year_id** : INT <<PK>>
    --
    year_code : INT <<UQ>>
    year_name : NVARCHAR(100)
    status : NVARCHAR(20)
    start_date : SMALLDATETIME
    end_date : SMALLDATETIME
    created_by : INT <<FK>>
  }

  class fact_approved_projects <<fact>> {
    **approved_project_id** : INT <<PK>>
    --
    cost_plan_year_id : INT <<FK>>
    project_id : INT <<FK>>
    section_id : INT <<FK>>
    project_wbse : NVARCHAR(50)
    project_name : NVARCHAR(500)
    trust_fund : NVARCHAR(80)
    earmarking_type : NVARCHAR(80)
    implementing_grant : NVARCHAR(120)
    project_start_date : DATE
    project_end_date : DATE
    carried_over_flag : BIT
    finance_officer_incharge : INT <<FK>>
    created_by : INT <<FK>>
    is_active : BIT
    ..
    <<UQ>> (cost_plan_year_id, project_id)
  }
}

' ═══════════════════════════════════════════════════════════
'  PARAMETERS (project-level + salary)
' ═══════════════════════════════════════════════════════════

package "Parameters" <<Rectangle>> {

  class fact_year_project_parameters <<fact>> {
    **year_project_parameter_id** : INT <<PK>>
    --
    approved_project_id : INT <<FK>>
    programme_support_costs : DECIMAL(18,6)
    common_staff_costs_professional : DECIMAL(18,6)
    common_staff_costs_general : DECIMAL(18,6)
    common_staff_costs_national : DECIMAL(18,6)
    ashi : DECIMAL(18,6)
    appendix : DECIMAL(18,6)
    notes : NVARCHAR(500)
    is_active : BIT
  }

  package "Salary Parameters" <<Rectangle>> {

    class fact_country_wise_salary_parameter_sets <<fact>> {
      **cwsp_parameter_set_id** : INT <<PK>>
      --
      cost_plan_year_id : INT <<FK>>
      country_id : INT <<FK>>
      currency_code : CHAR(3)
      exchange_rate_to_usd : DECIMAL(18,6)
      post_adjustment_multiplier : DECIMAL(18,6)
      inflation_rate : DECIMAL(18,6)
      notes : NVARCHAR(500)
      is_active : BIT
      ..
      <<UQ>> (year, country)
    }

    class fact_country_specific_grade_salaries <<fact>> {
      **grade_salary_id** : INT <<PK>>
      --
      cwsp_parameter_set_id : INT <<FK>>
      post_grade_id : INT <<FK>>
      salary_amount : DECIMAL(19,4)
      is_usd : BIT
      notes : NVARCHAR(500)
      is_active : BIT
      ..
      <<UQ>> (parameter_set, grade)
    }
  }
}

' ═══════════════════════════════════════════════════════════
'  COST DATA (positions, costing, activity/operating costs)
' ═══════════════════════════════════════════════════════════

package "Cost Data" <<Rectangle>> {

  class fact_project_positions <<fact>> {
    **project_position_id** : INT <<PK>>
    --
    approved_project_id : INT <<FK>>
    position_number : NVARCHAR(50)
    encumbered : NVARCHAR(200)
    post_grade_id : INT <<FK>>
    duty_station_id : INT <<FK>>
    country_id : INT <<FK>>
    funding_start_date : SMALLDATETIME
    funding_end_date : SMALLDATETIME
    jan_posts .. dec_posts : DECIMAL(6,2)
    notes : NVARCHAR(500)
    is_active : BIT
    ..
    <<UQ>> (approved_project_id, position_number)
  }

  class fact_deployment <<fact>> {
    **deployment_id** : INT <<PK>>
    --
    approved_project_id : INT <<FK>>
    post_grade_id : INT <<FK>>
    country_id : INT <<FK>>
    jan_posts .. dec_posts : DECIMAL(6,2)
    notes : NVARCHAR(500)
    is_active : BIT
    ..
    <<UQ>> (project, grade, country)
  }

  class fact_costing <<auto-generated>> {
    **costing_id** : INT <<PK>>
    --
    cost_plan_year_id : INT <<FK>>
    approved_project_id : INT <<FK>>
    umoja_class_id : INT <<FK>>
    post_category_id : INT <<FK>>
    post_grade_id : INT <<FK>>
    country_id : INT <<FK>>
    cwsp_parameter_set_id : INT <<FK>>
    net_base_amount : DECIMAL(18,2)
    common_staff_cost_amount : DECIMAL(18,2)
    q1..q4_amount : DECIMAL(18,2)
    released_budget_approved : DECIMAL(18,2)
    this_request : DECIMAL(18,2)
    total_released_budget : DECIMAL(18,2)
    notes : NVARCHAR(500)
    is_active : BIT
    ..
    <<UQ>> (year, project, grade, country)
  }

  class fact_activity_costs <<fact>> {
    **activity_cost_id** : INT <<PK>>
    --
    cost_plan_year_id : INT <<FK>>
    approved_project_id : INT <<FK>>
    activity_type : NVARCHAR(50)
    umoja_class_id : INT <<FK>>
    result_oe : NVARCHAR(500)
    output_text : NVARCHAR(1000)
    activity_text : NVARCHAR(1000)
    responsibility : NVARCHAR(500)
    gender_equality_main_objective : NVARCHAR(10)
    source_text : NVARCHAR(500)
    object_description : NVARCHAR(1000)
    commitment_id : INT
    potential_future_rb : NVARCHAR(10)
    q1..q4_amount : DECIMAL(18,2)
    released_budget_approved : DECIMAL(18,2)
    this_request : DECIMAL(18,2)
    total_released_budget : DECIMAL(18,2)
    notes : NVARCHAR(500)
    is_active : BIT
  }

  class fact_operating_costs <<fact>> {
    **operating_cost_id** : INT <<PK>>
    --
    cost_plan_year_id : INT <<FK>>
    approved_project_id : INT <<FK>>
    operating_cost_category_id : INT <<FK>>
    number_of_units : DECIMAL(18,2)
    duration : DECIMAL(18,2)
    rate_per_unit : DECIMAL(18,2)
    q1..q4_amount : DECIMAL(18,2)
    released_budget_approved : DECIMAL(18,2)
    this_request : DECIMAL(18,2)
    total_released_budget : DECIMAL(18,2)
    notes : NVARCHAR(500)
    is_active : BIT
  }
}

' ═══════════════════════════════════════════════════════════
'  STAFFING (kept for future use — not used by current code)
' ═══════════════════════════════════════════════════════════

package "Staffing (reserved — unused)" <<Rectangle>> {

  class fact_position_assignments <<fact>> {
    **position_assignment_id** : INT <<PK>>
    --
    project_position_id : INT <<FK>>
    assignment_title : NVARCHAR(200)
    assignment_start_date : SMALLDATETIME
    assignment_end_date : SMALLDATETIME
    is_active : BIT
  }
}

' ═══════════════════════════════════════════════════════════
'  TABLE-VALUED PARAMETER TYPES (used by write SPs)
' ═══════════════════════════════════════════════════════════

skinparam class {
  BackgroundColor<<tvp>> #ECEFF1
  BorderColor<<tvp>> #455A64
}

package "User-Defined Table Types\n(TVPs for bulk write SPs)" <<Rectangle>> {

  class DeploymentRowType <<tvp>> {
    post_grade_id : INT
    country_id : INT
    jan..dec_posts : DECIMAL(6,2)
    notes : NVARCHAR(500)
  }

  class OperatingCostRowType <<tvp>> {
    operating_cost_category_id : INT
    number_of_units, duration, rate : DECIMAL
    q1..q4_amount : DECIMAL(18,2)
    released/this_request/total : DECIMAL
    notes : NVARCHAR(500)
  }

  class ActivityCostRowType <<tvp>> {
    activity_cost_id : INT (NULL=new)
    cost_plan_year_id : INT
    activity_type, text fields...
    q1..q4_amount : DECIMAL(18,2)
    released/this_request/total : DECIMAL
    notes : NVARCHAR(500)
  }

  class CostingEditRowType <<tvp>> {
    post_grade_id : INT
    post_category_id : INT
    country_id : INT
    released/this_request/total : DECIMAL
    notes : NVARCHAR(500)
  }

  class StaffingRowType <<tvp>> {
    project_position_id : INT (NULL=new)
    position_number : NVARCHAR(50)
    encumbered : NVARCHAR(200)
    post_grade_id : INT
    duty_station_id, country_id : INT
    funding_start/end_date : SMALLDATETIME
    jan..dec_posts : DECIMAL(6,2)
    notes : NVARCHAR(500)
  }

  class GradeSalaryRowType <<tvp>> {
    post_grade_id : INT
    salary_amount : DECIMAL(19,4)
    is_usd : BIT
    notes : NVARCHAR(500)
  }

  class IntIdListType <<tvp>> {
    id : INT
  }
}

' ═══════════════════════════════════════════════════════════
'  MAPPING TABLES (green)
' ═══════════════════════════════════════════════════════════

package "Mapping Tables" <<Rectangle>> {

  class map_user_role_assignments <<map>> {
    **user_role_assignment_id** : INT <<PK>>
    --
    user_id : INT <<FK>>
    user_role_id : INT <<FK>>
    assigned_at : DATETIME2(0)
    is_active : BIT
    ..
    <<UQ>> (user, role)
  }

  class map_section_country <<map>> {
    **division_code** : NVARCHAR(50) <<PK>>
    **branch_name** : NVARCHAR(200) <<PK>>
    **section_name** : NVARCHAR(200) <<PK>>
    --
    country_code : CHAR(3) <<FK>>
  }
}

' ═══════════════════════════════════════════════════════════
'  RELATIONSHIPS
' ═══════════════════════════════════════════════════════════

' --- Org hierarchy ---
ref_divisions "1" --o{ "0..*" ref_branches : division_id
ref_branches "1" --o{ "0..*" ref_sections : branch_id
ref_sections "0..*" }o-- "0..1" ref_countries : country_id
ref_projects "0..*" }o-- "1" ref_sections : section_id

' --- Duty stations ---
ref_duty_stations "0..*" }o-- "1" ref_countries : country_id

' --- Post classification ---
ref_post_categories "1" --o{ "0..*" ref_post_grades : post_category_id

' --- Umoja classification ---
ref_umoja_classes "1" --o{ "0..*" ref_operating_cost_categories : umoja_class_id
ref_umoja_classes "1" --o{ "0..*" ref_activity_categories : umoja_class_id

' --- Cost Plan Years ---
fact_cost_plan_years "0..*" }o-- "0..1" fact_users : created_by

' --- Approved Projects ---
fact_approved_projects "0..*" }o-- "1" fact_cost_plan_years : cost_plan_year_id
fact_approved_projects "0..*" }o-- "1" ref_projects : project_id
fact_approved_projects "0..*" }o-- "1" ref_sections : section_id
fact_approved_projects "0..*" }o-- "0..1" fact_users : finance_officer
fact_approved_projects "0..*" }o-- "0..1" fact_users : created_by

' --- Project Positions ---
fact_project_positions "0..*" }o-- "1" fact_approved_projects : approved_project_id
fact_project_positions "0..*" }o-- "1" ref_post_grades : post_grade_id
fact_project_positions "0..*" }o-- "0..1" ref_duty_stations : duty_station_id
fact_project_positions "0..*" }o-- "0..1" ref_countries : country_id

' --- Position Assignments ---
fact_position_assignments "0..*" }o-- "1" fact_project_positions : project_position_id

' --- Salary Parameters ---
fact_country_wise_salary_parameter_sets "0..*" }o-- "1" fact_cost_plan_years : cost_plan_year_id
fact_country_wise_salary_parameter_sets "0..*" }o-- "1" ref_countries : country_id
fact_country_specific_grade_salaries "0..*" }o-- "1" fact_country_wise_salary_parameter_sets : cwsp_parameter_set_id
fact_country_specific_grade_salaries "0..*" }o-- "1" ref_post_grades : post_grade_id

' --- Costing (auto-generated by sp_compute_costing) ---
fact_costing "0..*" }o-- "1" fact_cost_plan_years : cost_plan_year_id
fact_costing "0..*" }o-- "1" fact_approved_projects : approved_project_id
fact_costing "0..*" }o-- "1" ref_umoja_classes : umoja_class_id
fact_costing "0..*" }o-- "1" ref_post_categories : post_category_id
fact_costing "0..*" }o-- "1" ref_post_grades : post_grade_id
fact_costing "0..*" }o-- "1" fact_country_wise_salary_parameter_sets : cwsp_parameter_set_id
fact_costing "0..*" }o-- "0..1" ref_countries : country_id

' --- Deployment ---
fact_deployment "0..*" }o-- "1" fact_approved_projects : approved_project_id
fact_deployment "0..*" }o-- "1" ref_post_grades : post_grade_id
fact_deployment "0..*" }o-- "0..1" ref_countries : country_id

' --- Activity Costs ---
fact_activity_costs "0..*" }o-- "1" fact_cost_plan_years : cost_plan_year_id
fact_activity_costs "0..*" }o-- "1" fact_approved_projects : approved_project_id
fact_activity_costs "0..*" }o-- "0..1" ref_umoja_classes : umoja_class_id

' --- Operating Costs ---
fact_operating_costs "0..*" }o-- "1" fact_cost_plan_years : cost_plan_year_id
fact_operating_costs "0..*" }o-- "1" fact_approved_projects : approved_project_id
fact_operating_costs "0..*" }o-- "1" ref_operating_cost_categories : operating_cost_category_id

' --- Year Project Parameters ---
fact_year_project_parameters "0..*" }o-- "1" fact_approved_projects : approved_project_id

' --- User Role Assignments ---
map_user_role_assignments "0..*" }o-- "1" fact_users : user_id
map_user_role_assignments "0..*" }o-- "1" ref_user_roles : user_role_id

' --- Section Country Mapping ---
map_section_country "0..*" }o-- "1" ref_countries : country_code

@enduml
